#! /bin/sh
patch -p1 -l -f $* < $0
exit $?
From 3e7e50eb1a442a5f832f7395e77b1117d39662b2 Mon Sep 17 00:00:00 2001
From: Carl Schwan <carl.schwan@gnupg.com>
Date: Tue, 4 Jun 2024 17:54:29 +0200
Subject: [PATCH 1/3] Disable dbus on windows and macOS

---
 CMakeLists.txt     | 52 +++++++++++++++++++++++++++++++++++++---------
 src/CMakeLists.txt |  4 +++-
 2 files changed, 45 insertions(+), 11 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 9f9b6e0..56627d9 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -30,12 +30,44 @@ include(ECMFeatureSummary)
 include(ECMAddTests)
 include(ECMAddQch)

+option(FORCE_NOT_REQUIRED_DEPENDENCIES "List (semicolon-separated) of dependencies that will be downgraded from REQUIRED to RECOMMENDED")
+
+function(set_libkdepim_optional_package_properties _name _props)
+    if(NOT "${_props}" STREQUAL "PROPERTIES")
+        message(FATAL_ERROR "PROPERTIES keyword is missing in set_libkdepim_optional_package_properties() call.")
+    endif()
+
+    set(options) # none
+    set(oneValueArgs DESCRIPTION URL PURPOSE)
+    set(multiValueArgs) # none
+
+    CMAKE_PARSE_ARGUMENTS(_SPP "${options}" "${oneValueArgs}" "${multiValueArgs}"  ${ARGN})
+
+    if(_SPP_UNPARSED_ARGUMENTS)
+        message(FATAL_ERROR "Unknown keywords given to set_libkdepim_optional_package_properties(): \"${_SPP_UNPARSED_ARGUMENTS}\"")
+    endif()
+
+    set(DEPENDENCY_TYPE "REQUIRED")
+    if (${_name} IN_LIST FORCE_NOT_REQUIRED_DEPENDENCIES)
+        set(DEPENDENCY_TYPE "RECOMMENDED")
+    endif()
+    set_package_properties(${_name} PROPERTIES
+        TYPE ${DEPENDENCY_TYPE}
+        DESCRIPTION ${_SPP_DESCRIPTION}
+        URL ${_SPP_URL}
+        PURPOSE "${_SPP_PURPOSE} You can make the dependency optional adding ${_name} to the FORCE_NOT_REQUIRED_DEPENDENCIES cmake option"
+    )
+endfunction()
+
+find_package(Qt6DBus ${REQUIRED_QT_VERSION})
+set_libkdepim_optional_package_properties(Qt6DBus PROPERTIES
+    PURPOSE "Required for the DBUS interfaces delegate.")

 option(BUILD_QCH "Build API documentation in QCH format (for e.g. Qt Assistant, Qt Creator & KDevelop)" OFF)
 add_feature_info(QCH ${BUILD_QCH} "API documentation in QCH format (for e.g. Qt Assistant, Qt Creator & KDevelop)")

 set(LIBKDEPIM_LIB_VERSION ${PIM_VERSION})
-find_package(Qt6 ${QT_REQUIRED_VERSION} CONFIG REQUIRED Widgets Test DBus Network)
+find_package(Qt6 ${QT_REQUIRED_VERSION} CONFIG REQUIRED Widgets Test Network)

 find_package(KF6Completion ${KF_MIN_VERSION} CONFIG REQUIRED)
 find_package(KF6I18n ${KF_MIN_VERSION} CONFIG REQUIRED)
@@ -54,16 +86,16 @@ endif()
 ########### CMake Config Files ###########
 set(CMAKECONFIG_INSTALL_DIR "${KDE_INSTALL_CMAKEPACKAGEDIR}/KPim6Libkdepim")

+if (Qt6::DBus)
+    configure_package_config_file(KPimMailTransportDBusServiceConfig.cmake.in
+      ${CMAKE_CURRENT_BINARY_DIR}/KPim6MailTransportDBusServiceConfig.cmake
+      PATH_VARS KDE_INSTALL_DBUSINTERFACEDIR
+      INSTALL_DESTINATION "${KDE_INSTALL_CMAKEPACKAGEDIR}/KPim6MailTransportDBusService")

-
-configure_package_config_file(KPimMailTransportDBusServiceConfig.cmake.in
-  ${CMAKE_CURRENT_BINARY_DIR}/KPim6MailTransportDBusServiceConfig.cmake
-  PATH_VARS KDE_INSTALL_DBUSINTERFACEDIR
-  INSTALL_DESTINATION "${KDE_INSTALL_CMAKEPACKAGEDIR}/KPim6MailTransportDBusService")
-
-install(FILES
-  ${CMAKE_CURRENT_BINARY_DIR}/KPim6MailTransportDBusServiceConfig.cmake
-  DESTINATION "${KDE_INSTALL_CMAKEPACKAGEDIR}/KPim6MailTransportDBusService")
+    install(FILES
+      ${CMAKE_CURRENT_BINARY_DIR}/KPim6MailTransportDBusServiceConfig.cmake
+      DESTINATION "${KDE_INSTALL_CMAKEPACKAGEDIR}/KPim6MailTransportDBusService")
+endif()

 option(USE_UNITY_CMAKE_SUPPORT "Use UNITY cmake support (speedup compile time)" OFF)

diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt
index b252a35..23770a3 100644
--- a/src/CMakeLists.txt
+++ b/src/CMakeLists.txt
@@ -139,7 +139,9 @@ if(BUILD_DESIGNERPLUGIN)
 endif()
 ########### install files ###############

-install(FILES interfaces/org.kde.addressbook.service.xml interfaces/org.kde.mailtransport.service.xml DESTINATION ${KDE_INSTALL_DBUSINTERFACEDIR})
+if (Qt6::DBus)
+    install(FILES interfaces/org.kde.addressbook.service.xml interfaces/org.kde.mailtransport.service.xml DESTINATION ${KDE_INSTALL_DBUSINTERFACEDIR})
+endif()

 install(FILES
     ${CMAKE_CURRENT_BINARY_DIR}/libkdepim_version.h
--
2.44.0
